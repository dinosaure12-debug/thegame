<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>The Game - Solo & Multijoueur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Optionnel : police un peu plus technique/élégante pour les numéros -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #020617;
      color: #f9fafb;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      margin-top: 16px;
      margin-bottom: 4px;
      font-size: 20px;
      text-align: center;
    }

    .subtitle {
      font-size: 13px;
      color: #e5e7eb;
      margin-bottom: 10px;
      text-align: center;
    }

    .container {
      max-width: 900px;
      width: 100%;
      padding: 0 10px 24px 10px;
      box-sizing: border-box;
    }

    .info {
      font-size: 13px;
      margin-bottom: 6px;
      min-height: 32px;
    }

    .status {
      margin-top: 4px;
      margin-bottom: 12px;
      min-height: 24px;
      font-size: 13px;
      color: #fbbf24;
    }

    .board {
      margin-top: 10px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .pile-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* PILES – plus sombres, look massif */
    .base-card {
      width: 52px;
      height: 78px;
      border-radius: 8px;
      border: 2px solid #4b5563;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 20%, #111827 0%, #020617 60%, #000 100%);
      color: #e5e7eb;
      font-weight: 700;
      font-size: 16px;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 8px 16px rgba(0, 0, 0, 0.8);
    }

    .base-dir {
      font-size: 14px;
      margin-top: 2px;
      color: #9ca3af;
    }

    .pile-card {
      width: 52px;
      height: 78px;
      border-radius: 8px;
      border: 2px solid #374151;
      background: radial-gradient(circle at 20% 15%, #0b1220 0%, #020617 55%, #000 100%);
      color: #e5e7eb;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease, border-color 0.1s ease;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 8px 16px rgba(0, 0, 0, 0.8);
    }

    .pile-card:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 10px 18px rgba(0, 0, 0, 0.9);
      border-color: #6b7280;
      background: radial-gradient(circle at 20% 15%, #111827 0%, #020617 55%, #000 100%);
    }

    .pile-card:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.8),
        0 4px 10px rgba(0, 0, 0, 0.6);
    }

    .separator {
      width: 100%;
      height: 1px;
      background: #1f2937;
      margin: 12px 0;
    }

    .hand-title {
      margin-bottom: 6px;
      font-size: 14px;
    }

    .hand {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    /* CARTES BLUEPRINT TECHNIQUES – CSS only */
    .hand-card {
      width: 60px;
      height: 90px;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at 20% 15%, #0f172a 0%, #020617 60%, #020617 100%);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.7),
        0 8px 14px rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(129, 230, 217, 0.65);
      cursor: pointer;
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        border-color 0.1s ease,
        background 0.1s ease;
    }

    /* grille blueprint */
    .hand-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(191, 219, 254, 0.09) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(191, 219, 254, 0.09) 1px, transparent 1px);
      background-size: 7px 7px;
      opacity: 0.95;
      pointer-events: none;
    }

    /* cadre intérieur */
    .hand-card::after {
      content: "";
      position: absolute;
      inset: 5px;
      border-radius: 8px;
      border: 1px solid rgba(191, 219, 254, 0.5);
      box-shadow:
        0 0 8px rgba(129, 230, 217, 0.3),
        inset 0 0 12px rgba(15, 23, 42, 0.95);
      pointer-events: none;
    }

    .hand-card:hover {
      transform: translateY(-3px);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.9),
        0 10px 18px rgba(0, 0, 0, 1);
      border-color: rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at 20% 15%, #1d4ed8 0%, #020617 55%, #020617 100%);
    }

    .hand-card.selected {
      transform: translateY(-5px);
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 1),
        0 12px 20px rgba(0, 0, 0, 1);
      border-color: #f97316;
      background: radial-gradient(circle at 20% 15%, #1d4ed8 0%, #020617 55%, #000 100%);
    }

    .hand-card.disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow:
        0 0 0 1px rgba(31, 41, 55, 0.8),
        0 4px 10px rgba(0, 0, 0, 0.7);
    }

    .bp-number {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Cinzel", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 26px;
      color: #e5f2ff;
      text-shadow:
        0 0 6px rgba(129, 230, 217, 0.8),
        0 0 12px rgba(56, 189, 248, 0.7);
      z-index: 1;
    }

    .bp-corner {
      position: absolute;
      font-size: 10px;
      color: rgba(191, 219, 254, 0.9);
      z-index: 1;
    }
    .bp-corner.top-left     { top: 4px;  left: 6px; }
    .bp-corner.top-right    { top: 4px;  right: 6px; }
    .bp-corner.bottom-left  { bottom: 4px; left: 6px; }
    .bp-corner.bottom-right { bottom: 4px; right: 6px; }

    .controls {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 6px 12px;
      border-radius: 9999px;
      border: 1px solid #9ca3af;
      background: #020617;
      color: #f9fafb;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.1s ease, transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-primary {
      background: #f97316;
      border-color: #f97316;
      color: #111827;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .net-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      align-items: center;
      font-size: 12px;
    }

    .net-controls input {
      padding: 5px 10px;
      border-radius: 9999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 12px;
      width: 100px;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 9999px;
      border: 1px solid #6b7280;
      font-size: 11px;
      color: #e5e7eb;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>The Game – Solo & Multijoueur</h1>
    <div class="subtitle">Piles au centre, main par joueur, deck commun.</div>

    <!-- Zone mode / réseau -->
    <div class="net-controls">
      <span id="mode-badge" class="badge">Mode : solo local</span>
      <button id="btn-solo" class="btn">Mode solo</button>
      <button id="btn-create-online" class="btn">Créer partie</button>
      <input id="join-code-input" type="text" maxlength="6" placeholder="Code" />
      <button id="btn-join-online" class="btn">Rejoindre</button>
      <span id="room-info" class="badge"></span>
    </div>

    <div id="info" class="info"></div>
    <div id="status" class="status"></div>

    <!-- Jeu -->
    <div class="board">
      <div class="pile-row">
        <div class="base-card">100<div class="base-dir">↓</div></div>
        <button class="pile-card" id="pile-0">100</button>
      </div>
      <div class="pile-row">
        <div class="base-card">100<div class="base-dir">↓</div></div>
        <button class="pile-card" id="pile-1">100</button>
      </div>
      <div class="pile-row">
        <div class="base-card">1<div class="base-dir">↑</div></div>
        <button class="pile-card" id="pile-2">1</button>
      </div>
      <div class="pile-row">
        <div class="base-card">1<div class="base-dir">↑</div></div>
        <button class="pile-card" id="pile-3">1</button>
      </div>
    </div>

    <div class="separator"></div>

    <div class="hand-title">Ta main</div>
    <div id="hand" class="hand"></div>

    <div class="controls">
      <button id="new-game" class="btn">Reset</button>
      <button id="end-turn" class="btn btn-primary">Finir tour / Piocher</button>
    </div>
  </div>

  <script>
    /******** FIREBASE CONFIG ********/
    const firebaseConfig = {
      apiKey: "AIzaSyCRRVuWD29vt6qgp1iEBfPha-mNRQO2C54",
      authDomain: "the-game-80e93.firebaseapp.com",
      projectId: "the-game-80e93",
      storageBucket: "the-game-80e93.firebasestorage.app",
      messagingSenderId: "147107639100",
      appId: "1:147107639100:web:448b58c01837884bd33839"
    };

    let firebaseAvailable = true;
    try { firebase.initializeApp(firebaseConfig); }
    catch(e){ console.warn("Firebase error:", e); firebaseAvailable = false; }
    const db = firebaseAvailable ? firebase.firestore() : null;

    /******** LOGIQUE DE JEU ********/
    const HAND_SIZE = 8;
    const MIN_PLAYS_PER_TURN = 2; // utilisé en solo uniquement

    let mode = "solo";           // "solo" ou "online"
    let game = null;
    let selectedIndex = null;

    // Joueur local
    let localPlayerId = localStorage.getItem("thegame_player_id");
    if(!localPlayerId){
      localPlayerId="player-"+Math.random().toString(36).substring(2,10);
      localStorage.setItem("thegame_player_id",localPlayerId);
    }
    let currentRoomCode = null;
    let unsubscribeRoom = null;

    function sortHandAscending(hand) {
      if (Array.isArray(hand)) {
        hand.sort((a, b) => a - b);
      }
    }

    function createNewGameState(){
      const deck=[];
      for(let i=2;i<=99;i++) deck.push(i);
      for(let i=deck.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [deck[i],deck[j]]=[deck[j],deck[i]];
      }
      const piles=[
        {value:100,ascending:false},
        {value:100,ascending:false},
        {value:1,ascending:true},
        {value:1,ascending:true}
      ];
      const hand=[];
      while(hand.length<HAND_SIZE && deck.length>0){
        hand.push(deck.pop());
      }
      sortHandAscending(hand);
      return {deck,piles,hand,turn:1,playsThisTurn:0,gameOver:false};
    }

    // Pour le mode online : deck + piles + mains par joueur
    function createNewOnlineGameState(){
      const deck=[];
      for(let i=2;i<=99;i++) deck.push(i);
      for(let i=deck.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [deck[i],deck[j]]=[deck[j],deck[i]];
      }
      const piles=[
        {value:100,ascending:false},
        {value:100,ascending:false},
        {value:1,ascending:true},
        {value:1,ascending:true}
      ];
      return {
        deck,
        piles,
        hands:{},   // { playerId: [cartes] }
        gameOver:false
      };
    }

    function canPlay(pile,card){
      const v=pile.value;
      if(pile.ascending){
        return card>v || card===v-10;
      } else {
        return card<v || card===v+10;
      }
    }

    function hasAnyLegalMove(state){
      return state.hand.some(c=>state.piles.some(p=>canPlay(p,c)));
    }

    // pour online : renvoie la main du joueur (et la crée si besoin)
    function ensureHand(state, playerId){
      if(!state.hands) state.hands={};
      if(!state.hands[playerId]) state.hands[playerId]=[];
      return state.hands[playerId];
    }

    function allHandsEmpty(state){
      if(!state.hands) return true;
      return Object.values(state.hands).every(h=>!h || h.length===0);
    }

    function drawUpToHandFromDeck(state, hand, size){
      while(hand.length<size && state.deck.length>0){
        hand.push(state.deck.pop());
      }
      sortHandAscending(hand);
    }

    // version solo
    function drawUpTo(state,size){
      drawUpToHandFromDeck(state, state.hand, size);
    }

    function playOneCardOnState(state,handIdx,pileIdx){
      if(state.gameOver) return "La partie est terminée.";
      if(handIdx<0||handIdx>=state.hand.length) return "Index carte invalide.";
      const card=state.hand[handIdx];
      const pile=state.piles[pileIdx];
      if(!canPlay(pile,card)) return "Coup illégal.";
      pile.value=card;
      state.hand.splice(handIdx,1);
      state.playsThisTurn+=1;
      if(state.hand.length===0 && state.deck.length===0){
        state.gameOver=true;
        return "Victoire parfaite.";
      }
      return "OK";
    }

    function endTurnOnState(state){
      if(state.gameOver) return "Terminé.";
      if(state.deck.length>0 && state.playsThisTurn<MIN_PLAYS_PER_TURN)
        return "Tu dois jouer 2 cartes avant de finir le tour.";
      if(state.deck.length>0) drawUpTo(state,HAND_SIZE);
      state.playsThisTurn=0;
      state.turn+=1;
      if(state.hand.length===0 && state.deck.length===0){
        state.gameOver=true;
        return "Victoire parfaite.";
      }
      if(!hasAnyLegalMove(state)){
        state.gameOver=true;
        return "Bloqué.";
      }
      return "Tour "+state.turn;
    }

    // Online : jouer une carte depuis la main du joueur local
    function playOneCardOnlineOnState(state, playerId, handIdx, pileIdx){
      if(state.gameOver) return "La partie est terminée.";
      const hand = ensureHand(state, playerId);
      if(handIdx<0 || handIdx>=hand.length) return "Index carte invalide.";
      const card = hand[handIdx];
      const pile = state.piles[pileIdx];
      if(!canPlay(pile,card)) return "Coup illégal.";
      pile.value = card;
      hand.splice(handIdx,1);

      if(state.deck.length===0 && allHandsEmpty(state)){
        state.gameOver=true;
        return "Toutes les cartes ont été jouées.";
      }
      return "OK";
    }

    // Online : "finir tour" = piocher pour ce joueur
    function endTurnOnlineOnState(state, playerId){
      if(state.gameOver) return "La partie est terminée.";
      const hand = ensureHand(state, playerId);
      drawUpToHandFromDeck(state, hand, HAND_SIZE);
      if(state.deck.length===0 && allHandsEmpty(state)){
        state.gameOver=true;
        return "Toutes les cartes ont été jouées.";
      }
      return "Tu as pioché. À toi de jouer.";
    }

    /******** UI ********/
    function setStatus(t){ document.getElementById("status").innerText=t; }
    function setInfo(t){ document.getElementById("info").innerHTML=t; }

    function updateModeBadge(){
      const badge=document.getElementById("mode-badge");
      if(mode==="solo") badge.textContent="Mode : solo local";
      else badge.textContent="Mode : multijoueur";
    }

    function updateRoomInfo(){
      const el=document.getElementById("room-info");
      if(mode==="online" && currentRoomCode) el.textContent="Partie : "+currentRoomCode;
      else el.textContent="";
    }

    function getCurrentHand(){
      if(!game) return [];
      if(mode==="online" && game.hands){
        return ensureHand(game, localPlayerId);
      }
      return game.hand || [];
    }

    function render(){
      if(!game){
        setInfo("Clique sur Reset ou crée/rejoins une partie.");
        return;
      }
      const hand = getCurrentHand();
      if(selectedIndex!=null && selectedIndex>=hand.length) selectedIndex=null;

      const deckCount = game.deck ? game.deck.length : 0;

      setInfo(
        "Deck : <b>"+deckCount+
        "</b> — Cartes dans ta main : <b>"+hand.length+
        "</b><br/>Carte sélectionnée : "+
        (selectedIndex!=null ? "<b>"+hand[selectedIndex]+"</b>" : "<i>Aucune</i>")
      );

      for(let i=0;i<4;i++){
        const btn=document.getElementById("pile-"+i);
        btn.textContent=game.piles[i].value;
        btn.disabled=game.gameOver;
      }

      const handDiv=document.getElementById("hand");
      handDiv.innerHTML="";
      hand.forEach((c,i)=>{
        const card=document.createElement("div");
        card.className="hand-card"+(selectedIndex===i?" selected":"");
        if(game.gameOver) card.classList.add("disabled");

        const num = document.createElement("div");
        num.className = "bp-number";
        num.textContent = c;

        const tl = document.createElement("div");
        tl.className = "bp-corner top-left";
        tl.textContent = c;

        const tr = document.createElement("div");
        tr.className = "bp-corner top-right";
        tr.textContent = c;

        const bl = document.createElement("div");
        bl.className = "bp-corner bottom-left";
        bl.textContent = c;

        const br = document.createElement("div");
        br.className = "bp-corner bottom-right";
        br.textContent = c;

        card.appendChild(num);
        card.appendChild(tl);
        card.appendChild(tr);
        card.appendChild(bl);
        card.appendChild(br);

        card.onclick=()=>{
          if(game.gameOver) return;
          if(selectedIndex===i) selectedIndex=null;
          else selectedIndex=i;
          render();
        };
        handDiv.appendChild(card);
      });
    }

    /******** SOLO ********/
    function startSolo(){
      if(unsubscribeRoom) unsubscribeRoom();
      mode="solo";
      currentRoomCode=null;
      game=createNewGameState();
      selectedIndex=null;
      updateModeBadge();
      updateRoomInfo();
      setStatus("Mode solo.");
      render();
    }

    /******** MULTIJOUEUR ********/
    function subscribeRoom(code){
      if(!db) return;
      if(unsubscribeRoom) unsubscribeRoom();
      unsubscribeRoom = db.collection("rooms").doc(code).onSnapshot(s=>{
        if(!s.exists){
          setStatus("Partie supprimée.");
          return;
        }
        const data = s.data();
        game = data.game;
        render();
      });
    }

    async function createOnlineRoom(){
      if(!db) return setStatus("Firebase indisponible.");
      const code=Math.random().toString(36).substring(2,6).toUpperCase();
      currentRoomCode=code;
      const room=db.collection("rooms").doc(code);

      const initial = createNewOnlineGameState();
      const hostHand = ensureHand(initial, localPlayerId);
      drawUpToHandFromDeck(initial, hostHand, HAND_SIZE);

      await room.set({
        code,
        createdAt:Date.now(),
        hostId:localPlayerId,
        players:{ [localPlayerId]:{joinedAt:Date.now()} },
        game:initial
      });

      mode="online";
      updateModeBadge();
      updateRoomInfo();
      subscribeRoom(code);
      setStatus("Partie créée. Code : "+code);
      render();
    }

    async function joinOnlineRoom(){
      if(!db) return setStatus("Firebase indisponible.");
      const code=document.getEle